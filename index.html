<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; connect-src 'self';">
  <title>9M2PJU Simple Morse Code Trainer</title>
  <meta name="description" content="An interactive Morse Code Trainer by 9M2PJU. Practice and learn CW for amateur radio, military communications, and aviation."/>
  <meta name="keywords" content="Morse Code, CW, Trainer, Ham Radio, Amateur Radio, Military Comms, Aviation, Learn Morse, Practice Morse, 9M2PJU"/>
  <link rel="stylesheet" href="css/tailwind.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-J4Xz0j7gA5+7gA5+7gA5+7gA5+7gA5+7gA5+7gA5+7gA5+7gA5+7gA5+7gA5+7gA5"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23007bff'/%3E%3C/svg%3E" type="image/svg+xml">
</head>
<body class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4 sm:p-6">
  <h1 class="text-4xl font-bold text-blue-400 mb-2 animate-pulse">9M2PJU</h1>
  <p class="text-2xl text-gray-200 mb-6">Simple Morse Code Trainer</p>

  <!-- Theme Toggle -->
  <div class="mb-4">
    <label for="themeToggle" class="text-sm mr-2">Theme:</label>
    <select id="themeToggle" class="p-2 rounded-lg bg-gray-700 text-white" aria-label="Select theme">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>
  </div>

  <!-- Start Audio Button -->
  <button id="startAudioBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg mb-4 shadow-md transition-all duration-300" aria-label="Start audio context">Start Audio</button>

  <!-- Tabs -->
  <div class="flex space-x-2 sm:space-x-4 mb-6">
    <button id="tabEncode" class="tab-btn bg-blue-600 px-3 py-2 sm:px-4 sm:py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300" aria-label="Switch to Text to Morse mode">Text â†’ Morse</button>
    <button id="tabPractice" class="tab-btn bg-gray-700 px-3 py-2 sm:px-4 sm:py-2 rounded-lg shadow-md hover:bg-gray-600 transition-all duration-300" aria-label="Switch to Listen and Type mode">Listen & Type</button>
    <button id="showAlphabet" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-2 sm:px-4 sm:py-2 rounded-lg shadow-md transition-all duration-300" aria-label="Show Morse code alphabet">Morse Alphabet</button>
  </div>

  <!-- ENCODE MODE -->
  <div id="encodeMode" class="w-full max-w-lg sm:max-w-xl bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-semibold mb-4 text-blue-300">Convert Text to Morse & Play</h2>
    <textarea id="textInput" placeholder="Enter text (A-Z, 0-9, spaces only)..." class="w-full p-3 rounded-lg bg-gray-700 text-white mb-4 focus:ring-2 focus:ring-blue-500" aria-label="Enter text to convert to Morse code"></textarea>
    <p id="morseOutput" class="text-gray-200 mb-4 font-mono"></p>

    <!-- Sliders and Settings -->
    <div class="mb-4">
      <label for="freqSlider" class="block text-sm mb-1">Tone Frequency: <span id="freqValue">600</span> Hz</label>
      <input id="freqSlider" type="range" min="300" max="1000" value="600" class="w-full" aria-label="Adjust tone frequency">
    </div>
    <div class="mb-4">
      <label for="wpmSlider" class="block text-sm mb-1">Speed: <span id="wpmValue">20</span> WPM</label>
      <input id="wpmSlider" type="range" min="5" max="40" value="20" class="w-full" aria-label="Adjust Morse code speed">
    </div>
    <div class="mb-4">
      <label for="charSpeedSlider" class="block text-sm mb-1">Character Speed: <span id="charSpeedValue">20</span> WPM</label>
      <input id="charSpeedSlider" type="range" min="5" max="40" value="20" class="w-full" aria-label="Adjust character speed for Farnsworth spacing">
    </div>
    <div class="mb-4">
      <label for="waveformSelect" class="block text-sm mb-1">Waveform Type:</label>
      <select id="waveformSelect" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" aria-label="Select waveform type">
        <option value="sine">Sine (Clean)</option>
        <option value="triangle">Triangle (Warm)</option>
        <option value="filteredSine">Filtered Sine (Radio-like)</option>
      </select>
    </div>
    <div class="mb-4">
      <label for="backgroundNoise" class="block text-sm mb-1">Background Noise:</label>
      <input id="backgroundNoise" type="checkbox" class="mr-2" aria-label="Enable background noise">
      <span class="text-sm text-gray-400">Simulate radio static</span>
    </div>
    <p class="mt-2 text-gray-400 text-sm">Adjust settings for optimal audio experience.</p>

    <div class="flex flex-wrap gap-2 sm:gap-4 mt-4">
      <button id="playBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg shadow-md transition-all duration-300" aria-label="Play Morse code for entered text">Play Morse</button>
      <button id="stopBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg shadow-md transition-all duration-300 hidden" aria-label="Stop Morse code playback">Stop Playback</button>
      <button id="clearBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg shadow-md transition-all duration-300" aria-label="Clear text input">Clear</button>
    </div>
  </div>

  <!-- PRACTICE MODE -->
  <div id="practiceMode" class="hidden w-full max-w-lg sm:max-w-xl bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-semibold mb-4 text-blue-300">Listen & Type Practice</h2>
    <div class="mb-4">
      <label for="wordCategory" class="block text-sm mb-1">Practice Category:</label>
      <select id="wordCategory" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" aria-label="Select practice word category">
        <option value="all">All Words</option>
        <option value="letters">Letters Only</option>
        <option value="numbers">Numbers Only</option>
        <option value="qcodes">Q-Codes</option>
        <option value="ham">Ham Radio Terms</option>
        <option value="phonetic">Phonetic Alphabet</option>
        <option value="maritime">Maritime Terms</option>
        <option value="military">Military Terms</option>
        <option value="aviation">Aviation Terms</option>
        <option value="random">Random 5-Character Groups</option>
        <option value="custom">Custom Words</option>
      </select>
    </div>
    <div id="customWordsDiv" class="hidden mb-4">
      <label for="customWords" class="block text-sm mb-1">Custom Words (comma-separated):</label>
      <input id="customWords" type="text" placeholder="e.g., HELLO,CQ,TEST" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" aria-label="Enter custom words for practice">
    </div>
    <div class="mb-4">
      <label for="difficultyLevel" class="block text-sm mb-1">Difficulty Level:</label>
      <select id="difficultyLevel" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" aria-label="Select difficulty level">
        <option value="beginner">Beginner (Single Letters/Numbers)</option>
        <option value="intermediate">Intermediate (Short Words)</option>
        <option value="advanced">Advanced (Phrases/QSO)</option>
      </select>
    </div>
    <div class="mb-4">
      <label for="freqSliderPractice" class="block text-sm mb-1">Tone Frequency: <span id="freqValuePractice">600</span> Hz</label>
      <input id="freqSliderPractice" type="range" min="300" max="1000" value="600" class="w-full" aria-label="Adjust tone frequency">
    </div>
    <div class="mb-4">
      <label for="wpmSliderPractice" class="block text-sm mb-1">Speed: <span id="wpmValuePractice">20</span> WPM</label>
      <input id="wpmSliderPractice" type="range" min="5" max="40" value="20" class="w-full" aria-label="Adjust Morse code speed">
    </div>
    <div class="mb-4">
      <label for="charSpeedSliderPractice" class="block text-sm mb-1">Character Speed: <span id="charSpeedValuePractice">20</span> WPM</label>
      <input id="charSpeedSliderPractice" type="range" min="5" max="40" value="20" class="w-full" aria-label="Adjust character speed for Farnsworth spacing">
    </div>
    <div class="mb-4">
      <label for="waveformSelectPractice" class="block text-sm mb-1">Waveform Type:</label>
      <select id="waveformSelectPractice" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500" aria-label="Select waveform type">
        <option value="sine">Sine (Clean)</option>
        <option value="triangle">Triangle (Warm)</option>
        <option value="filteredSine">Filtered Sine (Radio-like)</option>
      </select>
    </div>
    <div class="mb-4">
      <label for="backgroundNoisePractice" class="block text-sm mb-1">Background Noise:</label>
      <input id="backgroundNoisePractice" type="checkbox" class="mr-2" aria-label="Enable background noise">
      <span class="text-sm text-gray-400">Simulate radio static</span>
    </div>
    <div class="flex flex-wrap gap-2 sm:gap-4 mb-4">
      <button id="startPractice" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg shadow-md transition-all duration-300" aria-label="Start practice session">Start Practice</button>
      <button id="stopPracticeBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg shadow-md transition-all duration-300 hidden" aria-label="Stop practice playback">Stop Playback</button>
    </div>
    <input id="practiceInput" type="text" placeholder="Type what you hear..." class="w-full p-3 rounded-lg bg-gray-700 text-white mb-4 focus:ring-2 focus:ring-blue-500" disabled aria-label="Type the Morse code you hear">
    <p id="practiceResult" class="text-lg font-semibold text-blue-300"></p>
    <div id="progressSection" class="mt-4">
      <h3 class="text-lg font-semibold mb-2 text-blue-300">Your Progress</h3>
      <p id="sessionStats" class="text-gray-200"></p>
      <canvas id="progressChart" class="mt-4"></canvas>
    </div>
  </div>

  <!-- MODAL -->
  <div id="alphabetModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" aria-hidden="true">
    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl w-11/12 max-w-2xl shadow-lg">
      <h3 class="text-2xl font-bold mb-4 text-yellow-400">Morse Code Alphabet</h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
        <div>A<br><span class="text-green-400">.-</span></div>
        <div>B<br><span class="text-green-400">-...</span></div>
        <div>C<br><span class="text-green-400">-.-.</span></div>
        <div>D<br><span class="text-green-400">-..</span></div>
        <div>E<br><span class="text-green-400">.</span></div>
        <div>F<br><span class="text-green-400">..-.</span></div>
        <div>G<br><span class="text-green-400">--.</span></div>
        <div>H<br><span class="text-green-400">....</span></div>
        <div>I<br><span class="text-green-400">..</span></div>
        <div>J<br><span class="text-green-400">.---</span></div>
        <div>K<br><span class="text-green-400">-.-</span></div>
        <div>L<br><span class="text-green-400">.-..</span></div>
        <div>M<br><span class="text-green-400">--</span></div>
        <div>N<br><span class="text-green-400">-.</span></div>
        <div>O<br><span class="text-green-400">---</span></div>
        <div>P<br><span class="text-green-400">.--.</span></div>
        <div>Q<br><span class="text-green-400">--.-</span></div>
        <div>R<br><span class="text-green-400">.-.</span></div>
        <div>S<br><span class="text-green-400">...</span></div>
        <div>T<br><span class="text-green-400">-</span></div>
        <div>U<br><span class="text-green-400">..-</span></div>
        <div>V<br><span class="text-green-400">...-</span></div>
        <div>W<br><span class="text-green-400">.--</span></div>
        <div>X<br><span class="text-green-400">-..-</span></div>
        <div>Y<br><span class="text-green-400">-.--</span></div>
        <div>Z<br><span class="text-green-400">--..</span></div>
        <div>0<br><span class="text-green-400">-----</span></div>
        <div>1<br><span class="text-green-400">.----</span></div>
        <div>2<br><span class="text-green-400">..---</span></div>
        <div>3<br><span class="text-green-400">...--</span></div>
        <div>4<br><span class="text-green-400">....-</span></div>
        <div>5<br><span class="text-green-400">.....</span></div>
        <div>6<br><span class="text-green-400">-....</span></div>
        <div>7<br><span class="text-green-400">--...</span></div>
        <div>8<br><span class="text-green-400">---..</span></div>
        <div>9<br><span class="text-green-400">----.</span></div>
      </div>
      <div class="text-center mt-6">
        <button id="closeModal" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg shadow-md transition-all duration-300" aria-label="Close Morse code alphabet modal">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Morse Map
    const morseMap = {
      'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.',
      'F': '..-.', 'G': '--.', 'H': '....', 'I': '..', 'J': '.---',
      'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---',
      'P': '.--.', 'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-',
      'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 'Y': '-.--',
      'Z': '--..', '0': '-----', '1': '.----', '2': '..---', '3': '...--',
      '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..',
      '9': '----.', ' ': '/'
    };

    // Word Categories (abridged for brevity, replace with full list from previous artifact)
    const wordCategories = {
      letters: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''),
      numbers: '0123456789'.split(''),
      qcodes: ['QSO', 'QTH', 'QRM', 'QRN', 'QRZ', 'QSL', 'QSY'],
      ham: ['CQ', 'TEST', 'HAM', 'RADIO', 'MORSE', 'QSO', '73'],
      phonetic: ['ALPHA', 'BRAVO', 'CHARLIE', 'DELTA', 'ECHO'],
      maritime: ['MAYDAY', 'PAN PAN', 'SECURITE', 'VHF'],
      military: ['MISSION', 'INTEL', 'GRID', 'SITREP'],
      aviation: ['ATC', 'CLEARANCE', 'TAKEOFF', 'LANDING'],
      all: [],
      random: []
    };
    wordCategories.all = [
      ...wordCategories.letters,
      ...wordCategories.numbers,
      ...wordCategories.qcodes,
      ...wordCategories.ham,
      ...wordCategories.phonetic,
      ...wordCategories.maritime,
      ...wordCategories.military,
      ...wordCategories.aviation
    ];

    // Audio setup
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let isPlaying = false;
    let stopPlayback = false;
    let toneFreq = 600;
    let wpm = 20;
    let charSpeed = 20;
    let waveformType = 'sine';
    let noiseNode = null;

    // Scoring variables
    let correctAnswers = 0;
    let totalAttempts = 0;
    let sessionStartTime = null;
    let progressHistory = JSON.parse(localStorage.getItem('morseProgress')) || [];
    let currentWord = '';

    // UI elements
    const themeToggle = document.getElementById('themeToggle');
    const startAudioBtn = document.getElementById('startAudioBtn');
    const encodeMode = document.getElementById('encodeMode');
    const practiceMode = document.getElementById('practiceMode');
    const tabEncode = document.getElementById('tabEncode');
    const tabPractice = document.getElementById('tabPractice');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    const textInput = document.getElementById('textInput');
    const morseOutput = document.getElementById('morseOutput');
    const startPractice = document.getElementById('startPractice');
    const stopPracticeBtn = document.getElementById('stopPracticeBtn');
    const practiceInput = document.getElementById('practiceInput');
    const practiceResult = document.getElementById('practiceResult');
    const showAlphabet = document.getElementById('showAlphabet');
    const alphabetModal = document.getElementById('alphabetModal');
    const closeModal = document.getElementById('closeModal');
    const freqSlider = document.getElementById('freqSlider');
    const wpmSlider = document.getElementById('wpmSlider');
    const freqValue = document.getElementById('freqValue');
    const wpmValue = document.getElementById('wpmValue');
    const charSpeedSlider = document.getElementById('charSpeedSlider');
    const charSpeedValue = document.getElementById('charSpeedValue');
    const waveformSelect = document.getElementById('waveformSelect');
    const backgroundNoise = document.getElementById('backgroundNoise');
    const wordCategory = document.getElementById('wordCategory');
    const customWords = document.getElementById('customWords');
    const customWordsDiv = document.getElementById('customWordsDiv');
    const difficultyLevel = document.getElementById('difficultyLevel');
    const sessionStats = document.getElementById('sessionStats');
    const progressChart = document.getElementById('progressChart');
    const freqSliderPractice = document.getElementById('freqSliderPractice');
    const wpmSliderPractice = document.getElementById('wpmSliderPractice');
    const freqValuePractice = document.getElementById('freqValuePractice');
    const wpmValuePractice = document.getElementById('wpmValuePractice');
    const charSpeedSliderPractice = document.getElementById('charSpeedSliderPractice');
    const charSpeedValuePractice = document.getElementById('charSpeedValuePractice');
    const waveformSelectPractice = document.getElementById('waveformSelectPractice');
    const backgroundNoisePractice = document.getElementById('backgroundNoisePractice');

    // Theme toggle
    themeToggle.addEventListener('change', () => {
      const theme = themeToggle.value;
      document.body.classList.remove('bg-gray-900', 'text-white', 'bg-gray-100', 'text-gray-900');
      if (theme === 'light') {
        document.body.classList.add('bg-gray-100', 'text-gray-900');
        encodeMode.classList.replace('bg-gray-800', 'bg-white');
        practiceMode.classList.replace('bg-gray-800', 'bg-white');
        textInput.classList.replace('bg-gray-700', 'bg-gray-200');
        morseOutput.classList.replace('text-gray-200', 'text-gray-700');
        practiceInput.classList.replace('bg-gray-700', 'bg-gray-200');
        sessionStats.classList.replace('text-gray-200', 'text-gray-700');
        alphabetModal.querySelector('div').classList.replace('bg-gray-800', 'bg-white');
      } else {
        document.body.classList.add('bg-gray-900', 'text-white');
        encodeMode.classList.replace('bg-white', 'bg-gray-800');
        practiceMode.classList.replace('bg-white', 'bg-gray-800');
        textInput.classList.replace('bg-gray-200', 'bg-gray-700');
        morseOutput.classList.replace('text-gray-700', 'text-gray-200');
        practiceInput.classList.replace('bg-gray-200', 'bg-gray-700');
        sessionStats.classList.replace('text-gray-700', 'text-gray-200');
        alphabetModal.querySelector('div').classList.replace('bg-white', 'bg-gray-800');
      }
      localStorage.setItem('morseTheme', theme);
    });

    // Initialize AudioContext
    startAudioBtn.addEventListener('click', async () => {
      try {
        if (audioCtx.state === 'suspended') {
          await audioCtx.resume();
          console.log('AudioContext resumed');
          startAudioBtn.textContent = 'Audio Ready';
          startAudioBtn.classList.replace('bg-blue-600', 'bg-green-500');
          startAudioBtn.disabled = true;
        }
      } catch (e) {
        console.error('Failed to resume AudioContext:', e);
        alert('Unable to start audio. Please ensure your browser allows audio playback.');
      }
    });

    // Generate random 5-character group
    function generateRandomGroup(length = 5) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');
      return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    // Convert text to Morse for display
    function textToMorse(text) {
      return text.toUpperCase().split('').map(char => morseMap[char] || '').join(' ');
    }

    // Create background noise
    function createNoise() {
      try {
        const bufferSize = audioCtx.sampleRate * 5;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          data[i] = Math.random() * 2 - 1;
        }
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.loop = true;
        const gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
        source.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        return { source, gainNode };
      } catch (e) {
        console.error('Failed to create noise:', e);
        return null;
      }
    }

    // Audio handling with fade-in/out
    function playTone(duration, startTime) {
      if (stopPlayback) return Promise.resolve();
      try {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        if (waveformType === 'filteredSine') {
          const filter = audioCtx.createBiquadFilter();
          filter.type = 'lowpass';
          filter.frequency.setValueAtTime(toneFreq * 2, startTime);
          gainNode.connect(filter);
          filter.connect(audioCtx.destination);
        } else {
          gainNode.connect(audioCtx.destination);
        }
        oscillator.type = waveformType === 'triangle' ? 'triangle' : 'sine';
        oscillator.frequency.setValueAtTime(toneFreq, startTime);
        const fadeTime = Math.min(0.02, duration * 0.1);
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(1, startTime + fadeTime);
        gainNode.gain.linearRampToValueAtTime(0, startTime + duration - fadeTime);
        oscillator.start(startTime);
        oscillator.stop(startTime + duration);
        return new Promise(resolve => setTimeout(resolve, duration * 1000));
      } catch (e) {
        console.error('playTone error:', e);
        return Promise.resolve();
      }
    }

    // Play Morse code
    async function playMorse(text) {
      if (isPlaying) return;
      isPlaying = true;
      stopPlayback = false;
      try {
        if (audioCtx.state === 'suspended') {
          alert('Please click "Start Audio" to enable sound.');
          isPlaying = false;
          return;
        }
        if (backgroundNoise.checked && !noiseNode) {
          noiseNode = createNoise();
          if (noiseNode) noiseNode.source.start();
        }
        const unit = 1200 / wpm;
        const charUnit = 1200 / charSpeed;
        const dotDuration = charUnit / 1000;
        const dashDuration = charUnit * 3 / 1000;
        const intraCharSpace = charUnit / 1000;
        const charSpace = unit * 3 / 1000;
        const wordSpace = unit * 7 / 1000;
        let currentTime = audioCtx.currentTime;
        for (const char of text.toUpperCase()) {
          if (stopPlayback) break;
          if (char === ' ') {
            currentTime += wordSpace;
            continue;
          }
          if (morseMap[char]) {
            for (const symbol of morseMap[char]) {
              if (stopPlayback) break;
              const duration = symbol === '.' ? dotDuration : dashDuration;
              await playTone(duration, currentTime);
              currentTime += duration + intraCharSpace;
            }
            currentTime += charSpace - intraCharSpace;
          }
        }
        await new Promise(resolve => setTimeout(resolve, (currentTime - audioCtx.currentTime) * 1000));
        if (noiseNode && !stopPlayback) {
          noiseNode.gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
          noiseNode.source.stop(audioCtx.currentTime + 0.05);
          noiseNode = null;
        }
      } catch (e) {
        console.error('playMorse error:', e);
        alert('Unable to play audio. Please ensure your browser allows audio playback.');
      } finally {
        isPlaying = false;
        stopBtn.classList.add('hidden');
        stopPracticeBtn.classList.add('hidden');
        playBtn.classList.remove('hidden');
        startPractice.classList.remove('hidden');
      }
    }

    // Tab switching
    tabEncode.addEventListener('click', () => {
      try {
        encodeMode.classList.remove('hidden');
        practiceMode.classList.add('hidden');
        tabEncode.classList.replace('bg-gray-700', 'bg-blue-600');
        tabPractice.classList.replace('bg-blue-600', 'bg-gray-700');
        console.log('Switched to Encode Mode');
      } catch (e) {
        console.error('Tab Encode error:', e);
      }
    });

    tabPractice.addEventListener('click', () => {
      try {
        encodeMode.classList.add('hidden');
        practiceMode.classList.remove('hidden');
        tabPractice.classList.replace('bg-gray-700', 'bg-blue-600');
        tabEncode.classList.replace('bg-blue-600', 'bg-gray-700');
        console.log('Switched to Practice Mode');
      } catch (e) {
        console.error('Tab Practice error:', e);
      }
    });

    // Modal handling
    showAlphabet.addEventListener('click', () => {
      try {
        alphabetModal.classList.remove('hidden');
        console.log('Opened Morse Alphabet modal');
      } catch (e) {
        console.error('Show Alphabet error:', e);
      }
    });

    closeModal.addEventListener('click', () => {
      try {
        alphabetModal.classList.add('hidden');
        console.log('Closed Morse Alphabet modal');
      } catch (e) {
        console.error('Close Modal error:', e);
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        try {
          alphabetModal.classList.add('hidden');
          console.log('Closed modal with Escape key');
        } catch (e) {
          console.error('Escape key error:', e);
        }
      }
    });

    // Event listeners for Encode Mode
    textInput.addEventListener('input', () => {
      const text = textInput.value.replace(/[^A-Z0-9\s]/gi, '');
      textInput.value = text;
      morseOutput.textContent = textToMorse(text);
      localStorage.setItem('morseText', text);
    });

    playBtn.addEventListener('click', () => {
      const text = textInput.value.trim();
      if (text) {
        playBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');
        playMorse(text);
      }
    });

    stopBtn.addEventListener('click', () => {
      stopPlayback = true;
      if (noiseNode) {
        noiseNode.gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
        noiseNode.source.stop(audioCtx.currentTime + 0.05);
        noiseNode = null;
      }
    });

    clearBtn.addEventListener('click', () => {
      textInput.value = '';
      morseOutput.textContent = '';
      localStorage.removeItem('morseText');
    });

    freqSlider.addEventListener('input', () => {
      toneFreq = parseInt(freqSlider.value);
      freqValue.textContent = toneFreq;
      localStorage.setItem('morseTone', toneFreq);
      freqSliderPractice.value = toneFreq;
      freqValuePractice.textContent = toneFreq;
    });

    wpmSlider.addEventListener('input', () => {
      wpm = parseInt(wpmSlider.value);
      wpmValue.textContent = wpm;
      localStorage.setItem('morseWpm', wpm);
      wpmSliderPractice.value = wpm;
      wpmValuePractice.textContent = wpm;
    });

    charSpeedSlider.addEventListener('input', () => {
      charSpeed = parseInt(charSpeedSlider.value);
      charSpeedValue.textContent = charSpeed;
      localStorage.setItem('morseCharSpeed', charSpeed);
      charSpeedSliderPractice.value = charSpeed;
      charSpeedValuePractice.textContent = charSpeed;
    });

    waveformSelect.addEventListener('change', () => {
      waveformType = waveformSelect.value;
      localStorage.setItem('morseWaveform', waveformType);
      waveformSelectPractice.value = waveformType;
    });

    backgroundNoise.addEventListener('change', () => {
      backgroundNoisePractice.checked = backgroundNoise.checked;
      if (backgroundNoise.checked && !isPlaying) {
        noiseNode = createNoise();
        if (noiseNode) noiseNode.source.start();
      } else if (noiseNode) {
        noiseNode.gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
        noiseNode.source.stop(audioCtx.currentTime + 0.05);
        noiseNode = null;
      }
      localStorage.setItem('morseBackgroundNoise', backgroundNoise.checked);
    });

    // Practice Mode logic (abridged, replace with full logic from previous artifact)
    startPractice.addEventListener('click', async () => {
      try {
        if (audioCtx.state === 'suspended') {
          alert('Please click "Start Audio" to enable sound.');
          return;
        }
        startPractice.classList.add('hidden');
        stopPracticeBtn.classList.remove('hidden');
        practiceInput.disabled = false;
        practiceInput.focus();
        const category = wordCategory.value;
        let wordList = wordCategories[category] || wordCategories.all;
        if (category === 'custom') {
          wordList = customWords.value.split(',').map(w => w.trim().toUpperCase()).filter(w => w.match(/^[A-Z0-9\s]+$/));
        } else if (category === 'random') {
          wordList = [generateRandomGroup()];
        }
        currentWord = wordList[Math.floor(Math.random() * wordList.length)];
        await playMorse(currentWord);
        practiceInput.value = '';
        practiceResult.textContent = '';
      } catch (e) {
        console.error('Start Practice error:', e);
        alert('Unable to start practice. Please try again.');
      }
    });

    // Sync practice mode settings
    freqSliderPractice.addEventListener('input', () => {
      toneFreq = parseInt(freqSliderPractice.value);
      freqValuePractice.textContent = toneFreq;
      localStorage.setItem('morseTone', toneFreq);
      freqSlider.value = toneFreq;
      freqValue.textContent = toneFreq;
    });

    wpmSliderPractice.addEventListener('input', () => {
      wpm = parseInt(wpmSliderPractice.value);
      wpmValuePractice.textContent = wpm;
      localStorage.setItem('morseWpm', wpm);
      wpmSlider.value = wpm;
      wpmValue.textContent = wpm;
    });

    charSpeedSliderPractice.addEventListener('input', () => {
      charSpeed = parseInt(charSpeedSliderPractice.value);
      charSpeedValuePractice.textContent = charSpeed;
      localStorage.setItem('morseCharSpeed', charSpeed);
      charSpeedSlider.value = charSpeed;
      charSpeedValue.textContent = charSpeed;
    });

    waveformSelectPractice.addEventListener('change', () => {
      waveformType = waveformSelectPractice.value;
      localStorage.setItem('morseWaveform', waveformType);
      waveformSelect.value = waveformType;
    });

    backgroundNoisePractice.addEventListener('change', () => {
      backgroundNoise.checked = backgroundNoisePractice.checked;
      if (backgroundNoisePractice.checked && !isPlaying) {
        noiseNode = createNoise();
        if (noiseNode) noiseNode.source.start();
      } else if (noiseNode) {
        noiseNode.gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
        noiseNode.source.stop(audioCtx.currentTime + 0.05);
        noiseNode = null;
      }
      localStorage.setItem('morseBackgroundNoise', backgroundNoisePractice.checked);
    });

    // Load settings
    window.addEventListener('load', () => {
      try {
        textInput.value = localStorage.getItem('morseText') || '';
        morseOutput.textContent = textToMorse(textInput.value);
        toneFreq = parseInt(localStorage.getItem('morseTone')) || 600;
        wpm = parseInt(localStorage.getItem('morseWpm')) || 20;
        charSpeed = parseInt(localStorage.getItem('morseCharSpeed')) || 20;
        waveformType = localStorage.getItem('morseWaveform') || 'sine';
        backgroundNoise.checked = localStorage.getItem('morseBackgroundNoise') === 'true';
        const theme = localStorage.getItem('morseTheme') || 'dark';
        freqSlider.value = toneFreq;
        wpmSlider.value = wpm;
        charSpeedSlider.value = charSpeed;
        waveformSelect.value = waveformType;
        freqValue.textContent = toneFreq;
        wpmValue.textContent = wpm;
        charSpeedValue.textContent = charSpeed;
        freqSliderPractice.value = toneFreq;
        wpmSliderPractice.value = wpm;
        charSpeedSliderPractice.value = charSpeed;
        waveformSelectPractice.value = waveformType;
        backgroundNoisePractice.checked = backgroundNoise.checked;
        freqValuePractice.textContent = toneFreq;
        wpmValuePractice.textContent = wpm;
        charSpeedValuePractice.textContent = charSpeed;
        themeToggle.value = theme;
        if (theme === 'light') {
          document.body.classList.add('bg-gray-100', 'text-gray-900');
          encodeMode.classList.replace('bg-gray-800', 'bg-white');
          practiceMode.classList.replace('bg-gray-800', 'bg-white');
          textInput.classList.replace('bg-gray-700', 'bg-gray-200');
          morseOutput.classList.replace('text-gray-200', 'text-gray-700');
          practiceInput.classList.replace('bg-gray-700', 'bg-gray-200');
          sessionStats.classList.replace('text-gray-200', 'text-gray-700');
          alphabetModal.querySelector('div').classList.replace('bg-gray-800', 'bg-white');
        }
        console.log('Settings loaded');
      } catch (e) {
        console.error('Load error:', e);
      }
    });
  </script>
</body>
</html>
