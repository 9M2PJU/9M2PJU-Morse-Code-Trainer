<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Morse Code Trainer</title>
  <meta name="description" content="Practice and learn Morse code with live audio and random word training.">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .modal {
      display: none;
    }
    .modal.active {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 p-4 max-w-2xl mx-auto">
  <h1 class="text-3xl font-bold text-center mb-4">🎙️ Live Morse Code Trainer</h1>
  <p class="text-center mb-6 text-sm">A modern, web-based Morse Code learning tool. Built with ❤️ by 9M2PJU, based on the work of the original developer <a href="https://github.com/xcash" class="text-blue-600 underline">xcash</a>.</p>

  <!-- Text to Morse -->
  <section class="mb-8">
    <h2 class="text-xl font-semibold mb-2">📝 Text → Morse</h2>
    <textarea id="textInput" class="w-full p-2 border rounded mb-2" rows="3" placeholder="Type your message..."></textarea>
    <div class="flex gap-2">
      <button onclick="playMorseText()" class="bg-blue-600 text-white px-4 py-2 rounded">▶ Play Morse</button>
      <button onclick="document.getElementById('textInput').value=''" class="bg-gray-300 px-4 py-2 rounded">Clear</button>
    </div>
  </section>

  <!-- Practice Mode -->
  <section class="mb-8">
    <h2 class="text-xl font-semibold mb-2">🎧 Listen & Type Practice</h2>
    <div class="space-y-2">
      <div class="flex gap-2">
        <button id="startBtn" onclick="startPractice()" class="bg-green-600 text-white px-4 py-2 rounded">▶ Start</button>
        <button id="stopBtn" onclick="stopPractice()" class="bg-red-600 text-white px-4 py-2 rounded" disabled>⏹ Stop</button>
      </div>
      <input id="practiceInput" class="w-full p-2 border rounded" placeholder="Type the word you hear..." oninput="checkInput()" disabled>
      <p id="feedback" class="text-blue-700 font-semibold"></p>
    </div>
  </section>

  <!-- Morse Code Reference -->
  <section class="mb-6">
    <button onclick="toggleModal()" class="text-indigo-700 underline">📖 Morse Alphabet</button>
  </section>

  <!-- Modal -->
  <div id="morseModal" class="modal fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow max-w-sm w-full relative">
      <button onclick="toggleModal()" class="absolute top-2 right-3 text-xl text-gray-500">✖</button>
      <h3 class="text-lg font-bold mb-4">Morse Code Chart</h3>
      <pre class="text-sm font-mono">
A .-     B -...   C -.-.   D -..    E .      F ..-.
G --.    H ....   I ..     J .---   K -.-    L .-..
M --     N -.     O ---    P .--.   Q --.-   R .-.
S ...    T -      U ..-    V ...-   W .--    X -..-
Y -.--   Z --..   1 .----  2 ..---  3 ...--  4 ....-
5 .....  6 -....  7 --...  8 ---..  9 ----.  0 -----
      </pre>
    </div>
  </div>

  <footer class="text-center text-sm mt-12 text-gray-500">
    &copy; 2025 <a href="https://hamradio.my" class="underline text-blue-600">hamradio.my</a> · <a href="https://github.com/9M2PJU/9M2PJU-Morse-Code-Trainer" class="underline">Source Code</a>
  </footer>

  <script>
    const morseCodeMap = {
      A: ".-", B: "-...", C: "-.-.", D: "-..", E: ".", F: "..-.",
      G: "--.", H: "....", I: "..", J: ".---", K: "-.-", L: ".-..",
      M: "--", N: "-.", O: "---", P: ".--.", Q: "--.-", R: ".-.",
      S: "...", T: "-", U: "..-", V: "...-", W: ".--", X: "-..-",
      Y: "-.--", Z: "--..",
      1: ".----", 2: "..---", 3: "...--", 4: "....-", 5: ".....",
      6: "-....", 7: "--...", 8: "---..", 9: "----.", 0: "-----"
    };

    function playMorse(message) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const dot = 0.1;
      const dash = dot * 3;
      const space = dot;
      const freq = 600;
      let time = ctx.currentTime;

      const oscillator = ctx.createOscillator();
      const gain = ctx.createGain();
      oscillator.frequency.value = freq;
      oscillator.connect(gain);
      gain.connect(ctx.destination);
      oscillator.start();

      function beep(duration) {
        gain.gain.setValueAtTime(1, time);
        time += duration;
        gain.gain.setValueAtTime(0, time);
        time += space;
      }

      message.toUpperCase().split('').forEach(c => {
        if (c === ' ') time += dot * 4;
        else if (morseCodeMap[c]) {
          morseCodeMap[c].split('').forEach(s => beep(s === '.' ? dot : dash));
          time += dot * 2;
        }
      });

      oscillator.stop(time);
    }

    function playMorseText() {
      const text = document.getElementById('textInput').value;
      playMorse(text);
    }

    function toggleModal() {
      document.getElementById('morseModal').classList.toggle('active');
    }

    let currentWord = '';
    let practiceActive = false;
    const input = () => document.getElementById('practiceInput');
    const feedback = () => document.getElementById('feedback');

    async function getRandomWord() {
      try {
        const res = await fetch('https://random-word-api.herokuapp.com/word?number=1');
        const [word] = await res.json();
        return word.toUpperCase();
      } catch {
        return ['CQ', 'HELLO', 'WORLD'][Math.floor(Math.random() * 3)];
      }
    }

    async function startPractice() {
      if (practiceActive) return;
      practiceActive = true;

      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;

      input().disabled = false;
      input().value = '';
      feedback().textContent = '🔊 Listen and type the word...';

      currentWord = await getRandomWord();
      playMorse(currentWord);
      input().focus();
    }

    function stopPractice() {
      practiceActive = false;
      currentWord = '';
      input().disabled = true;
      feedback().textContent = 'Practice stopped.';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    function checkInput() {
      const typed = input().value.trim().toUpperCase();
      if (typed === currentWord) {
        feedback().textContent = `✅ Correct: ${currentWord}`;
        setTimeout(() => {
          if (practiceActive) startPractice();
        }, 1000);
      }
    }
  </script>
</body>
</html>
